#!/bin/bash
#===============================================================================
# Module services
#   see ManuelProgrammeurServices
#===============================================================================

#-------------------------------------------------------------------------------
# Create all services
#-------------------------------------------------------------------------------
yaneCreateServices () {
  for serv in ${serviceName[@]}
  do
    yaneCreateService_${serviceType[$serv]} $serv
  done
}

#-------------------------------------------------------------------------------
# Create all services
#-------------------------------------------------------------------------------
yaneShutdownServices () {
  for serv in ${serviceName[@]}
  do
    yaneShutdownService_${serviceType[$serv]} $serv
  done
}

#-------------------------------------------------------------------------------
# Deletes services + delete bridge yane0
#-------------------------------------------------------------------------------
yaneDeleteServices () {
  for serv in ${serviceName[@]}
  do
    yaneDeleteService_${serviceType[$serv]} $serv
  done
  $IP link del yane0
}

#-------------------------------------------------------------------------------
# Set NAT and connect services
#-------------------------------------------------------------------------------
yaneConnectServices () {
  logMessage LOG "Connecting services ..."
  br_name="yane0"
  ip_addr_bridge="192.168.1.254"
  service_ID=1
  ip_addr_service="192.168.1.$service_ID"
  netmask=24

  # Mise en place du bridge
  $IP link add $br_name type bridge
  if [ $? -eq 0 ]; then
    $IP link set $br_name up
    $IP addr add ${ip_addr_bridge}/$netmask dev $br_name
  fi

  # Remise à zéro du NAT
  iptables -P FORWARD DROP
  iptables -F FORWARD
  iptables -t nat -F

  for serv in ${serviceName[@]}
  do
    yaneConnectService_${serviceType[$serv]} $serv $br_name $ip_addr_bridge $netmask $($IP route | awk '/default/ { print $5 }') $ip_addr_service
    (( service_ID+1 ))
    ip_addr_service="192.168.1.$service_ID"
  done
  # Mise a jour du NAT du votre machine
  iptables -t nat -A POSTROUTING -s ${ip_addr_service}/$netmask -o enp0s25 -j MASQUERADE
  iptables -A FORWARD -i enp0s25 -o $br_name -j ACCEPT
  iptables -A FORWARD -o enp0s25 -i $br_name -j ACCEPT
}
